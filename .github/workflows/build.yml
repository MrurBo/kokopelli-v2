name: Build and Deploy Jekyll Site

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write   # âœ… allows pushing to branches

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up Ruby
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          gem install jekyll bundler
          bundle lock --add-platform x86_64-linux
          bundle install

      # 4. Build the site
      - name: Build Jekyll site
        run: |
          bundle exec jekyll build
          cp ./CNAME ./_site/CNAME

      # 5. Push _site to gh-pages branch
      - name: Push to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch object for gh-pages
          git fetch origin gh-pages || echo "gh-pages branch doesn't exist yet"

          git switch --orphan gh-pages
          git --work-tree=_site add --all
          git --work-tree=_site commit -m "Deploy site via GitHub Actions"
          git push --force "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" gh-pages
